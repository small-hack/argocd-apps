---
# has to be after secrets, but before web-app
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: juicefs-valkey-cluster-appset
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  goTemplate: true
  # generator allows us to source specific values from an external k8s secret
  generators:
    - plugin:
        configMapRef:
          name: secret-var-plugin-generator
        input:
          parameters:
            secret_vars:
              - juicefs_valkey_password
  template:
    metadata:
      name: juicefs-valkey-cluster
      annotations:
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: juicefs
      destination:
        server: https://kubernetes.default.svc
        namespace: juicefs
      syncPolicy:
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
        automated:
          prune: true
          selfHeal: true
      source:
        repoURL: 'registry-1.docker.io'
        chart: bitnamicharts/valkey-cluster
        targetRevision: 0.1.2
        helm:
          values: |
            fullnameOverride: "valkey"

            usePassword: false
            password: ""
            existingSecret: ""
            existingSecretPasswordKey: ""

            tls:
              enabled: true
              authClients: true
              autoGenerated: true

            service:
              ports:
                valkey: 6379
              type: ClusterIP
              loadBalancerIP: ""
              loadBalancerSourceRanges: []
              externalTrafficPolicy: Cluster

            persistence:
              enabled: true
              path: /bitnami/valkey/data
              storageClass: "local-path"
              annotations:
                k8up.io/backup: "true"
              accessModes:
                - ReadWriteOnce
              size: 8Gi

            persistentVolumeClaimRetentionPolicy:
              enabled: false
              whenScaled: Retain
              whenDeleted: Retain

            valkey:
              command: []
              args: []
              updateStrategy:
                type: RollingUpdate
                rollingUpdate:
                  partition: 0
              podManagementPolicy: Parallel
              automountServiceAccountToken: false
              hostNetwork: false
              useAOFPersistence: "yes"
              containerPorts:
                valkey: 6379
                bus: 16379
              resourcesPreset: "small"
              resources: {}

            cluster:
              init: true
              nodes: 6
              replicas: 1
              externalAccess:
                enabled: false
                hostMode: false
                service:
                  disableLoadBalancerIP: false
                  type: LoadBalancer
                  port: 6379
                  loadBalancerIP: []
                  loadBalancerSourceRanges: []

            metrics:
              enabled: false
              resourcesPreset: "micro"
              serviceMonitor:
                enabled: false


