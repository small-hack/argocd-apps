---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: forgejo-valkey-cluster-appset
  namespace: argocd
spec:
  # enable go templating
  goTemplate: true
  generators:
    - plugin:
        configMapRef:
          name: secret-var-plugin-generator
        input:
          parameters:
            secret_vars:
              - global_time_zone
  template:
    metadata:
      name: forgejo-valkey-cluster-app
      annotations:
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: default
      destination:
        server: https://kubernetes.default.svc
        namespace: forgejo

      syncPolicy:
        syncOptions:
          - CreateNamespace=true
          - ApplyOutOfSyncOnly=true
        automated:
          prune: true
          selfHeal: true

      source:
        repoURL: 'registry-1.docker.io'
        chart: bitnamicharts/valkey-cluster
        targetRevision: 2.2.1
        helm:
          valuesObject:

            global:
              storageClass: "local-path"

            fullnameOverride: "valkey"

            usePassword: true
            existingSecret: "forgejo-valkey-credentials"
            existingSecretPasswordKey: "valkey-password"

            tls:
              enabled: false
              authClients: true
              autoGenerated: false

            persistence:
              enabled: true
              path: /bitnami/valkey/data
              storageClass: local-path
              annotations:
                k8up.io/backup: 'true'
              accessModes:
                - ReadWriteOnce
              size: 8G

            persistentVolumeClaimRetentionPolicy:
              enabled: true
              whenScaled: Retain
              whenDeleted: Retain

            valkey:
              command: []
              args: []
              updateStrategy:
                type: RollingUpdate
                rollingUpdate:
                  partition: 0

              podManagementPolicy: Parallel
              automountServiceAccountToken: false
              hostNetwork: false
              containerPorts:
                valkey: 6379
                bus: 16379

              resourcesPreset: "small"

            cluster:
              init: true
              nodes: 3
              replicas: 0
              externalAccess:
                enabled: false
                hostMode: false
                service:
                  disableLoadBalancerIP: false
                  type: LoadBalancer
                  port: 6379
                  loadBalancerIP: []
                  loadBalancerSourceRanges: []

            # metrics on valkey cluster
            metrics:
              # we use a grafana exporter that logs into valkey directly
              enabled: true
              resourcesPreset: nano
