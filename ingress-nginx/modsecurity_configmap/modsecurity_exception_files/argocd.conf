# -------------------------------------------------------------------------
# allow deletions from the argocd web ui
# TODO: can maybe prune the methods here a bit more
# -------------------------------------------------------------------------
SecRule REQUEST_FILENAME "@beginsWith /api/v1/applications/" \
    "id:70001,\
    phase:1,\
    ver:'argocd-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE'"

SecRule REQUEST_FILENAME "@beginsWith /api/v1/projects/" \
    "id:70002,\
    phase:1,\
    ver:'argocd-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE',\
    ctl:ruleRemoveTargetById=930120;ARGS:json.project.spec.sourceRepos.array_1,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.project.spec.sourceRepos.array_2,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.project.spec.sourceRepos.array_3,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.project.spec.sourceRepos.array_5,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.project.spec.sourceRepos.array_6,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.project.metadata.annotations.kubectl.kubernetes.io/last-applied-configuration"

# -------------------------------------------------------------------------
# Allow argo to get appdetails and git information
# Bypass false positive Restricted File Access Attempt Event
# Rule ID #930130
# -------------------------------------------------------------------------
SecRule REQUEST_FILENAME "@rx ^\/api\/v1\/repositories\/.*\/appdetails" \
    "id:70003,\
    phase:1,\
    ver:'argocd-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=930130"
