# -------------------------------------------------------------------------
# allow postgresql to upload wal archives to s3
# allow PUT, DELETE, and POST methods for base backups for the following:
# forgejo
# gotosocial
# harbor
# mastodon
# matrix
# nextcloud
# peertube
# zitadel
# -------------------------------------------------------------------------
SecRule REQUEST_URI "@rx ^/(?:matrix|zitadel|nextcloud|gotosocial|mastodon|harbor|forgejo|peertube)-postgres/(?:matrix|zitadel|nextcloud|gotosocial|mastodon|harbor|forgejo|peertube)-postgres/(?:wals|base)/.*$" \
  "id:20000,\
  phase:1,\
  ver:'postgres-rule-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920340,\
  ctl:ruleRemoveById=921110,\
  ctl:ruleRemoveById=920440,\
  setvar:'tx.allowed_methods=DELETE GET POST HEAD PUT'"

# Prevents blocking uploads of WAL and Base backups to s3
# allow "Request Containing Content, but Missing Content-Type header"
# rule 920340
# Ignore false positive:
# Remote Command Execution: Java process spawn (CVE-2017-9805)
# 944110
# Ignore false positive:
# Remote Command Execution: Java serialization (CVE-2015-4852)
# 944120
SecRule REQUEST_URI "@rx ^.*-postgres\/.*-postgres\/(wals|base)\/.*" \
  "id:570001,\
  phase:1,\
  ver:'postgres-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=911100,\
  ctl:ruleRemoveById=920340,\
  ctl:ruleRemoveById=944100,\
  ctl:ruleRemoveById=944110,\
  ctl:ruleRemoveById=944120,\
  ctl:ruleRemoveById=944130"

# Prevents blocking pgbarman backup operations
SecRule REQUEST_URI "@rx ^.*-postgres.*" \
  "id:570002,\
  phase:1,\
  ver:'postgres-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"
