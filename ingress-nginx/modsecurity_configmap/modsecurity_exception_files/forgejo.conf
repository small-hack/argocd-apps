# -------------------------------------------------------------------------
# Prevent false positives for Server Side Request Forgery (SSRF) Attack
# Rule ID #934110
# -------------------------------------------------------------------------
SecRule REQUEST_URI "@rx ^\/login\/oauth\/authorize.*" \
    "id:140001,\
    phase:1,\
    ver:'forgejo-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=934110"

# -------------------------------------------------------------------------
# Allow looking a a file named .config
# URL file extension is restricted by policy. Rule ID #920440
# Restricted File Access Attempt. RuleID #930130
# -------------------------------------------------------------------------
SecRule REQUEST_HEADERS:Host "@streq git.smallhack.org" \
    "id:140002,\
    phase:1,\
    ver:'forgejo-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=920440,\
    ctl:ruleRemoveById=930130"

# -------------------------------------------------------------------------
# Allow cloning and pushing to a repo
# Request content type is not allowed by policy. Rule ID #920420
# -------------------------------------------------------------------------
SecRule REQUEST_HEADERS:Host "@streq git.smallhack.org" \
    "id:140003,\
    phase:1,\
    ver:'forgejo-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_request_content_type=|text/html|application/x-git-upload-pack-request|application/json|application/x-git-receive-pack-request|application/x-www-form-urlencoded|'"

# -------------------------------------------------------------------------
# Allow cloning a repo
# HTTP header is restricted by policy (/content-encoding/). Rule ID #920450
# -------------------------------------------------------------------------
SecRule REQUEST_HEADERS:Host "@streq git.smallhack.org" \
    "id:140004,\
    phase:1,\
    ver:'forgejo-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=920450"

# -------------------------------------------------------------------------
# Allow user deleting their own SSH or GPG key
# Rule ID #920420
# -------------------------------------------------------------------------
SecRule REQUEST_URI "@rx ^/user/settings/keys/delete?type=.*" \
    "id:140005,\
    phase:1,\
    ver:'forgejo-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_request_content_type=|text/html|application/x-git-upload-pack-request|application/json|application/x-git-receive-pack-request|application/x-www-form-urlencoded|multipart/form-data|'"

