# -------------------------------------------------------------------------
# allow uploads for matrix via element web and mobile
# to avoid rule 920420 which doesn't allow |application/octet-stream|
# -------------------------------------------------------------------------
# allow octet-stream content type for uploads
# url should be like /_matrix/media/v3/upload or /_matrix/media/r0/upload
SecRule REQUEST_URI "@rx ^/_matrix/media/(?:v3|r0)/upload.*$" \
    "id:40001,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_request_content_type=|application/octet-stream|image/jpeg|image/png|image/gif|'"

# allow PUT, OPTIONS to allow uploads
# url should be like /_matrix/media/v3/upload or /_matrix/media/r0/upload
SecRule REQUEST_URI "@rx ^/_matrix/media/(?:v3|r0)/upload.*$" \
    "id:40002,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=POST PUT OPTIONS'"

# allow PUT, OPTIONS to allow sending all sorts of user/room/device data:
# /_matrix/client/v3/user/username/account_data/im.vector.setting.breadcrumbs
# /_matrix/client/v3/sendToDevice/m.room.encrypted
# /_matrix/client/v3/room_keys/keys?version=1
# /_matrix/client/v3/profile
# /_matrix/client/v3/directory/room/
# /_matrix/client/v3/register
# /_matrix/client/v3/pushrules/global/room
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:v3|r0)/(?:rooms|user|devices|account|pushrules|profile|sendToDevice|room_keys|register|directory)/.*$" \
    "id:40003,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET POST PUT DELETE OPTIONS'"

# allow updating presense indicator
SecRule REQUEST_URI "@beginsWith /_matrix/client/r0/presence/" \
    "id:40004,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=PUT'"

# allow creating new rooms
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:v3|r0)/createRoom$" \
    "id:40005,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=933150;ARGS_NAMES:json.is_direct"

# allow prometheus alerts to be posted
# also allows key verification with weird keys
# /_matrix/client/r0/rooms/.*/send/m.room.message/.*
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:v3|r0)/rooms/.*/send/m.room.message/.*$" \
    "id:40006,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=920420,\
    ctl:ruleRemoveTargetById=933210;ARGS:json.formatted_body,\
    ctl:ruleRemoveTargetById=930120;ARGS:json.formatted_body"

# also allow edits to messages in encrypted rooms
# /_matrix/client/r0/rooms/.*/send/m.room.encrypted/.*
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:v3|r0)/rooms/.*/send/m.room.encrypted/.*$" \
    "id:40007,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=933150;ARGS:json.ciphertext"

# allow users to push up their keys from mobile or desktop
# /_matrix/client/r0/pushers/set
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:r0|v3)/pushers/set$" \
    "id:40008,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=930120;ARGS_NAMES:json.profile_tag"

# allows mautrix bridges to send things like:
# "Unknown command, use the `help` command for help."
# or
# "This is your management room: prefixing commands with `!discord` is not required.\n"
# which are responses from a bridge bot to a matrix user with admin access to the bot
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:v3|r0)/rooms/.*/send/m.room.message/mautrix-go_.*$"\
    "id:40009,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=942190;ARGS:json.body,\
    ctl:ruleRemoveTargetById=942360;ARGS:json.body,\
    ctl:ruleRemoveTargetById=932100;ARGS:json.body"

# allow PUT, OPTIONS to allow sending room key data:
# /_matrix/client/unstable/room_keys/keys?version=1
SecRule REQUEST_URI "@beginsWith /_matrix/client/unstable/room_keys/keys" \
    "id:40010,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET POST PUT DELETE OPTIONS',\
    ctl:ruleRemoveById=930120"

# this is for users forwarding room keys
# /_matrix/client/v3/room_keys/keys?version=1
SecRule REQUEST_URI "@rx ^/_matrix/client/(?:v3|r0)/room_keys/keys.*$" \
    "id:40011,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=930120"

# allow PUT method for sending read recipets
SecRule REQUEST_URI "@beginsWith /_matrix/federation/v1/send/" \
    "id:40012,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET POST PUT OPTIONS'"

# this is actually for a local s3 server that you have dedicated to matrix
# can be commented out if not running local s3 server such as seaweedfs
# /matrix/local_thumbnails/.*/32-32-image-jpeg-crop
SecRule REQUEST_URI "@rx ^\/matrix\/(?:local_thumbnails|local_content|remote_content|remote_thumbnail)\/.*" \
    "id:40013,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    nolog,\
    t:none,\
    setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE PATCH'"

SecRule REQUEST_URI "@rx ^\/matrix\/(local_content|remote_content)\/.*" \
    "id:40014,\
    phase:1,\
    ver:'matrix-rule-exclusions-plugin/1.0.0',\
    pass,\
    nolog,\
    t:none,\
    ctl:ruleRemoveById=920340"
