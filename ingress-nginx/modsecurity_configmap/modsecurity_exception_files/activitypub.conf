# Allow posting to mastodon inbox - rules 920420, 920470
# rule 920420 :Request content type is not allowed by policy
# also bypasses rule 920600 and 920420
SecRule REQUEST_URI "@rx ^\/(inbox|actor).*$" \
  "id:560000,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  ctl:ruleRemoveById=920420,\
  ctl:ruleRemoveById=920470,\
  ctl:ruleRemoveById=920600"

SecRule REQUEST_URI "@rx ^\/(users|accounts)\/.*\/inbox.*" \
  "id:560001,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|text/html'"

# allow editing and deleting statuses on mastodon - rule 911100
SecRule REQUEST_URI "@beginsWith /api/v1/statuses" \
  "id:560002,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# allow searching for statuses - rule 920470 and 920420
# see: https://github.com/coreruleset/coreruleset/issues/3497
SecRule REQUEST_URI "@rx ^/users/.*/statuses/.*$" \
  "id:560003,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json',\
  ctl:ruleRemoveById=920600"

# these are both for getting statuses (like if a status is searched for)
# avoids rule 920600
# avoids 942100 SQL Injection Attack Detected via libinjection
SecRule REQUEST_URI "@rx ^/@.*/statuses/.*$" \
  "id:560004,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920600,\
  ctl:ruleRemoveById=942100"

# avoids rule 920420 :Request content type is not allowed by policy
# this is actually for minio or seaweedfs to be able to support GoToSocial
# S3 enabled bucket lookups for images (Uploads)
SecRule REQUEST_URI "@rx ^/.*/.*/(attachment|emoji)/(static|small|original|)/.*$"
  "id:560005,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|'"

# Request content type is not allowed by policy
# removing rule from mastodon because attachments can be almost anything
SecRule REQUEST_URI "@rx ^.mastodon\/cache\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|files|avatars|headers).*$" \
  "id:560006,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|'"

# Same as above for for things not in cache
# Request content type is not allowed by policy
# removing rule from mastodon because attachments can be almost anything
SecRule REQUEST_URI "@rx ^.mastodon\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|thumbnails|files|avatars|headers).*$" \
  "id:560007,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|'"

# allow editing and deleting media_attachments
# /mastodon/media_attachments/files/*.fileending
SecRule REQUEST_URI "@rx ^.mastodon\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|thumbnails|files|avatars|headers).*$" \
  "id:560008,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# Ignore "Illegal Accept header: charset parameter" for gotosocial profiles
# see: https://github.com/coreruleset/coreruleset/issues/3497
# Rule: 920600
SecRule REQUEST_URI "@rx ^/users/.*$" \
  "id:560009,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920420,\
  ctl:ruleRemoveById=920470,\
  ctl:ruleRemoveById=920600"

# ALlow users to upload content
SecRule REQUEST_URI "@rx ^/users/.*$" \
  "id:560010,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|'"

# ALlow peertube subscriptions
SecRule REQUEST_URI "@rx ^/socket.io/.*$" \
  "id:560011,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|text/plain|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|'"

# these are both for getting statuses (like if a status is searched for) for peertube
# avoids rule 920600
SecRule REQUEST_URI "@rx ^\/(users|accounts)\/.*$" \
  "id:560012,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920600"

# Allow commenting on mastodon posts, bypasses rule 920600.
SecRule REQUEST_URI "@rx ^\/@.*\/.*$" \
  "id:560013,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920600"

# avoids rule 911100 :Method is not allowed by policy Event
# this is actually for minio or seaweedfs to be able to support GoToSocial
# S3 enabled bucket lookups for images (Uploads)
SecRule REQUEST_URI "@rx ^\/.*\/.*\/(attachment|emoji)\/(static|small|original)\/.*"
  "id:560014,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=911100,\
  ctl:ruleRemoveById=920340"

# allow users to get media
SecRule REQUEST_URI "@rx ^.mastodon\/.*\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|files|avatars|headers).*" \
  "id:560015,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=911100,\
  ctl:ruleRemoveById=920340"

# allow users to view their own account
SecRule REQUEST_URI "@rx ^\/(users|accounts)\/.*\/views.*" \
  "id:560016,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|text/html'"

# allow users to sign out lol
SecRule REQUEST_URI "@rx ^\/auth\/sign_out" \
  "id:560017,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS DELETE'"
