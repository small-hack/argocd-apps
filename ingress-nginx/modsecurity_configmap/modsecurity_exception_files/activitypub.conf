# Allow posting to mastodon inbox - rules 920420, 920470
# rule 920420 :Request content type is not allowed by policy
# also bypasses rule 920600 and 920420
SecRule REQUEST_URI "@rx ^\/(inbox|actor).*$" \
  "id:80000,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  ctl:ruleRemoveById=920420,\
  ctl:ruleRemoveById=920470,\
  ctl:ruleRemoveById=920600"

# contacting users
SecRule REQUEST_URI "@rx ^\/(users|accounts)\/.*\/inbox.*" \
  "id:80001,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|text/html'"

# allow editing and deleting statuses on mastodon - rule 911100
SecRule REQUEST_URI "@beginsWith /api/v1/statuses" \
  "id:80002,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# allow searching for statuses - rule 920470 and 920420
# see: https://github.com/coreruleset/coreruleset/issues/3497
SecRule REQUEST_URI "@rx ^/users/.*/statuses/.*$" \
  "id:80003,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json',\
  ctl:ruleRemoveById=920600"

# these are both for getting statuses (like if a status is searched for)
# avoids rule 920600
# avoids 942100 SQL Injection Attack Detected via libinjection
SecRule REQUEST_URI "@rx ^/@.*/statuses/.*$" \
  "id:80004,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920600,\
  ctl:ruleRemoveById=942100"

# avoids rule 920420 :Request content type is not allowed by policy
# this is actually for minio or seaweedfs to be able to support GoToSocial
# S3 enabled bucket lookups for images (Uploads)
SecRule REQUEST_URI "@rx ^/.*/.*/(attachment|emoji)/(static|small|original|)/.*$"
  "id:80005,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|audio/mpeg|'"

# Request content type is not allowed by policy
# removing rule from mastodon because attachments can be almost anything
SecRule REQUEST_URI "@rx ^.mastodon\/cache\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|files|avatars|headers).*$" \
  "id:80006,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|audio/mpeg|'"

# Same as above for for things not in cache
# Request content type is not allowed by policy
# removing rule from mastodon because attachments can be almost anything
SecRule REQUEST_URI "@rx ^.mastodon\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|thumbnails|files|avatars|headers).*$" \
  "id:80007,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|audio/mpeg'"

# allow editing and deleting media_attachments
# /mastodon/media_attachments/files/*.fileending
SecRule REQUEST_URI "@rx ^.mastodon\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|thumbnails|files|avatars|headers).*$" \
  "id:80008,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# Ignore "Illegal Accept header: charset parameter" for gotosocial profiles
# see: https://github.com/coreruleset/coreruleset/issues/3497
# Rule: 920600
SecRule REQUEST_URI "@rx ^/users/.*$" \
  "id:80009,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920420,\
  ctl:ruleRemoveById=920470,\
  ctl:ruleRemoveById=920600"

# ALlow users to upload content
SecRule REQUEST_URI "@rx ^/users/.*$" \
  "id:80010,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|audio/mpeg|'"

# Allow peertube subscriptions
SecRule REQUEST_URI "@rx ^/socket.io/.*$" \
  "id:80011,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|text/plain|image/png|image/jpg|image/jpeg|image/webp|image/gif|video/mpeg|video/mp4|video/webm|image/apng|application/octet-stream|application/xml|application/activity+json|audio/mpeg|'"

# these are both for getting statuses (like if a status is searched for) for peertube
# avoids rule 920600
SecRule REQUEST_URI "@rx ^\/(users|accounts)\/.*$" \
  "id:80012,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920600"

# Allow commenting on mastodon posts, bypasses rule 920600.
SecRule REQUEST_URI "@rx ^\/@.*\/.*$" \
  "id:80013,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920600"

# avoids rule 911100 :Method is not allowed by policy Event
# this is actually for minio or seaweedfs to be able to support GoToSocial
# S3 enabled bucket lookups for images (Uploads)
SecRule REQUEST_URI "@rx ^\/.*\/.*\/(attachment|emoji)\/(static|small|original)\/.*"
  "id:80014,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=911100,\
  ctl:ruleRemoveById=920340"

# allow users to get media
SecRule REQUEST_URI "@rx ^.mastodon\/.*\/(preview_cards|media_attachments|accounts|custom_emojis)\/(images|files|avatars|headers).*" \
  "id:80015,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=911100,\
  ctl:ruleRemoveById=920340"

# allow users to view their own account
SecRule REQUEST_URI "@rx ^\/(users|accounts)\/.*\/views.*" \
  "id:80016,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|text/html'"

# allow users to sign out lol
SecRule REQUEST_URI "@rx ^\/auth\/sign_out" \
  "id:80017,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS DELETE'"

# allow users to delete content from perrtube
# Bypass 920340 Request Containing Content, but Missing Content-Type header
SecRule REQUEST_URI "@rx ^\/peertube-postgres\?delete.*" \
  "id:80018,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920340"

# allow editing alt text on images on mastodon - rule 911100
SecRule REQUEST_URI "@beginsWith /api/v1/media" \
  "id:80019,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT'"

# Allow PUT method to mastodon /api/web/settings. This is a GlitchSoc endpoint that tracks your
# most-used emojis/languages for the picker dropdown.
# See: https://github.com/search?q=repo%3Aglitch-soc%2Fmastodon+frequentlyUsedEmojis&type=code
SecRule REQUEST_URI "@beginsWith /api/web/settings" \
  "id:80020,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT'"

## GoToSocial needs this for it's S3 stuff
# https://codeberg.org/superseriousbusiness/gotosocial/src/commit/6574dc8a09d127af23218796119d33b3badcb1f5/internal/storage/storage.go#L251
# avoid rule 911100: Method is not allowed by policy
# avoid rule 920420: Request content type is not allowed by policy
SecRule REQUEST_URI "@beginsWith /gotosocial/gotosocial-csp-probe" \
  "id:80021,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT DELETE'"

# avoid rule 920420: Request content type is not allowed by policy
SecRule REQUEST_URI "@beginsWith /gotosocial/gotosocial-csp-probe" \
  "id:80022,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded|multipart/form-data|text/xml|application/xml|application/soap+xml|application/json|application/octet-stream|'"


# allow editing lists in mastodon
SecRule REQUEST_URI "@beginsWith /api/v1/push/subscription" \
  "id:80023,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT DELETE'"

# allow editing lists in mastodon
SecRule REQUEST_URI "@beginsWith /api/v1/lists" \
  "id:80024,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT DELETE'"

# allow getting profiles like mastodon.social/@username
SecRule REQUEST_URI "@beginsWith /@" \
  "id:80025,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|text/html'"

# allow boosting statuses from gotosocial mastodon frontend
# example endpoint: /api/v1/statuses/75894jf89p328fp48924h/reblogyy
SecRule REQUEST_URI "@rx ^/api/v1/statuses/.*/reblog$" \
  "id:80026,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|application/json|application/x-www-form-urlencoded|'"

# allow PUT to reblog - rule 911100
# example endpoint: /api/v1/statuses/75894jf89p328fp48924h/reblog
SecRule REQUEST_URI "@rx ^\/api\/v1\/statuses\/.*\/reblog" \
  "id:80027,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT'"

# allow PATCH to change user credentials - rule 911100
# example endpoint: /api/v1/statuses/75894jf89p328fp48924h/reblog
SecRule REQUEST_URI "@rx ^\/api\/v1\/accounts\/update_credentials" \
  "id:80028,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH'"

# For peertube video channel editing
# avoids 1199 because the header has:
# REQUEST_HEADERS:Accept' (Value: `application/activity+json, application/ld+json; profile="https://www.w3.org/ns/activitystreams", tex (12 characters omitted)' )
SecRule REQUEST_URI "@rx /video-channels/.*$" \
  "id:80029,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json',\
  ctl:ruleRemoveById=920600"

# peertube: allow editing user profile (rule 911100)
SecRule REQUEST_URI "/api/v1/users/me" \
  "id:80030,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS'"

# peertube: allow new video upload (rule 911100)
SecRule REQUEST_URI "@beginsWith /api/v1/videos/" \
  "id:80031,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# peertube: allow new video upload
# 920450 allow Restricted header: /content-range/
# 932230 allow urls in the description of a video
SecRule REQUEST_URI "@beginsWith /api/v1/videos/" \
  "id:80032,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920450,\
  ctl:ruleRemoveById=932235,\
  ctl:ruleRemoveById=932250,\
  ctl:ruleRemoveById=932230"

# peertube allow new video upload
# 920420 allow |application/octet-stream|
SecRule REQUEST_URI "@beginsWith /api/v1/videos/upload-resumable?upload_id=" \
  "id:80033,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|application/octet-stream|'"

# Peertube allow video to be moved between s3 buckets after transcoding
# 911100 Method is not allowed by policy
SecRule REQUEST_URI "@beginsWith /hls/" \
  "id:80034,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# peertube allow new video upload (Content type)
# 920420 Request content type is not allowed
SecRule REQUEST_URI "@beginsWith /hls/" \
  "id:80035,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  ctl:ruleRemoveById=920420"

# peertube: allow setting configs
SecRule REQUEST_URI "@beginsWith /api/v1/config/" \
  "id:80036,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# Delete peertube subscriptions, to avoid 911100
SecRule REQUEST_URI "@rx ^/api/v1/users/me/subscriptions/.*$" \
  "id:80037,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  t:none,\
  setvar:'tx.allowed_methods=PUT POST GET HEAD OPTIONS DELETE'"

# allow looking up tags on gotosocial - rules 920470
SecRule REQUEST_URI "@rx ^/tags/.*$" \
  "id:80038,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  ctl:ruleRemoveById=920470"

# allow looking up images on gotosocial - rules 920470
SecRule REQUEST_URI "@rx ^/fileserver/.*/attachment/original/.*$" \
  "id:80039,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  ctl:ruleRemoveById=920470"

# allow looking up statuses for users on gotosocil - fixes rule 920420
SecRule REQUEST_URI "@rx ^/%40.*/statuses/.*$" \
  "id:80040,\
  phase:1,\
  ver:'activitypub-exclusions-plugin/1.0.0',\
  pass,\
  log,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/activity+json|application/ld+json|text/html|application/json|'"
