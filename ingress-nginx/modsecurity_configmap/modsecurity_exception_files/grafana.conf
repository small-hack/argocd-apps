# -------------------------------------------------------------------------
# allow exceptions for rules 933210, 942100, 932110 for using datasources
# loki and prometheus via grafana, should try to make these more granular later
# -------------------------------------------------------------------------
# needs tuning
# for catching grafana QL passed as ARGS:json.queries.array_0.expr in grafana
SecRule REQUEST_URI "@beginsWith /api/ds/query?ds_type" \
  "id:30001,\
  phase:1,\
  ver:'grafana-rule-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  ctl:ruleRemoveTargetById=932125;ARGS:json.queries.array_0.expr,\
  ctl:ruleRemoveTargetById=942100;ARGS:json.queries.array_0.expr,\
  ctl:ruleRemoveById=933210,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=932110"

# for catching grafana QL passed as ARGS:json.queries.array_0.expr in grafana
SecRule REQUEST_URI "@beginsWith /api/query-history" \
  "id:30002,\
  phase:1,\
  ver:'grafana-rule-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  ctl:ruleRemoveTargetById=932125;ARGS:json.queries.array_0.expr"

# needs tuning
SecRule REQUEST_URI "@beginsWith /api/datasources/uid/prometheus/resources/api/v1/label" \
  "id:30003,\
  phase:1,\
  pass,\
  ver:'grafana-rule-exclusions-plugin/1.0.0',\
  nolog,\
  ctl:ruleRemoveById=932110"

# this avoids issues when users change the default dashboard view
SecRule REQUEST_URI "@rx /api/user/helpflags/.*$" \
  "id:30004,\
  phase:1,\
  ver:'grafana-rule-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  setvar:'tx.allowed_methods=PUT'"

# this is for when a user tries to hit the explore link in a prometheus alert link
SecRule REQUEST_URI "@beginsWith /explore?orgId=" \
  "id:30005,\
  phase:1,\
  ver:'grafana-rule-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  ctl:ruleRemoveTargetById=932125;ARGS:left"

# Allow editing dashboards
SecRule REQUEST_URI "@beginsWith /api/dashboards" \
  "id:30006,\
  phase:1,\
  ver:'grafana-rule-exclusions-plugin/1.0.0',\
  pass,\
  nolog,\
  setvar:'tx.allowed_methods=PUT GET DELETE POST PATCH'"
