---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: ghost-activitypub-mysql-app-set
  namespace: argocd
spec:
  goTemplate: true
  # generator allows us to source specific values from an external k8s secret
  generators:
    - plugin:
        configMapRef:
          name: secret-var-plugin-generator
        input:
          parameters:
            secret_vars:
              - global_cluster_issuer
              - ghost_hostname
              - ghost_s3_endpoint

  template:
    metadata:
      name: ghost-activitypub-mysql
      annotations:
        # needs to be up before ghost but after the external secrets
        argocd.argoproj.io/sync-wave: "2"
    spec:
      project: ghost
      destination:
        server: https://kubernetes.default.svc
        namespace: ghost

      # reconcilation policy for this Argo CD Application
      syncPolicy:
        syncOptions:
          - ApplyOutOfSyncOnly=true
        automated:
          prune: true
          selfHeal: true

      source:
        repoURL: registry-1.docker.io
        chart: bitnamicharts/mysql
        targetRevision: 14.0.3
        helm:
          releaseName: "activitypub-mysql"
          # ref: https://github.com/bitnami/charts/blob/main/bitnami/mysql/values.yaml
          valuesObject:

            fullnameOverride: "activitypub-mysql"

            # MySQL architecture. Allowed values: `standalone` or `replication`
            architecture: standalone

            ## MySQL Authentication parameters
            # ref: https://github.com/bitnami/containers/tree/main/bitnami/mysql#setting-the-root-password-on-first-run
            #      https://github.com/bitnami/containers/tree/main/bitnami/mysql/#creating-a-database-on-first-run
            #      https://github.com/bitnami/containers/tree/main/bitnami/mysql/#creating-a-database-user-on-first-run
            auth:
              database: ghost
              username: ghost
              # Use existing secret for password details. secret has to contain:
              # mysql-root-password, mysql-replication-password, mysql-password
              existingSecret: "ghost-activitypub-mysql-credentials"

            ## MySQL Primary configuration
            primary:
              # MySQL Primary Persistence parameters
              persistence:
                enabled: true
                existingClaim: "ghost-activitypub-mysql"

              resources:
                requests:
                  cpu: 1
                  memory: 200Mi
                limits:
                  cpu: 3
                  memory: 1024Mi
