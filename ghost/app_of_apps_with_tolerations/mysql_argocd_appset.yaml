---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: ghost-mysql-app-set
  namespace: argocd
spec:
  goTemplate: true
  # generator allows us to source specific values from an external k8s secret
  generators:
    - plugin:
        configMapRef:
          name: secret-var-plugin-generator
        input:
          parameters:
            secret_vars:
              - global_cluster_issuer
              - ghost_hostname
              - ghost_s3_endpoint
              - ghost_toleration_key
              - ghost_toleration_operator
              - ghost_toleration_value
              - ghost_toleration_effect
              - ghost_affinity_key
              - ghost_affinity_value

  template:
    metadata:
      name: ghost-mysql
      annotations:
        # needs to be up before ghost but after the external secrets
        argocd.argoproj.io/sync-wave: "2"
    spec:
      project: ghost
      destination:
        server: https://kubernetes.default.svc
        namespace: ghost

      # reconcilation policy for this Argo CD Application
      syncPolicy:
        syncOptions:
          - ApplyOutOfSyncOnly=true
        automated:
          prune: true
          selfHeal: true

      source:
        repoURL: registry-1.docker.io
        chart: bitnamicharts/mysql
        targetRevision: 23.0.10
        helm:
          releaseName: "mysql"
          # ref: https://github.com/bitnami/charts/blob/main/bitnami/mysql/values.yaml
          valuesObject:

            fullnameOverride: "mysql"

            # MySQL architecture. Allowed values: `standalone` or `replication`
            architecture: standalone

            ## MySQL Authentication parameters ref:
            # https://github.com/bitnami/containers/tree/main/bitnami/mysql#setting-the-root-password-on-first-run
            # https://github.com/bitnami/containers/tree/main/bitnami/mysql/#creating-a-database-on-first-run
            # https://github.com/bitnami/containers/tree/main/bitnami/mysql/#creating-a-database-user-on-first-run
            auth:
              database: ghost
              username: ghost
              # Use existing secret for password details. secret has to contain:
              # mysql-root-password, mysql-replication-password, mysql-password
              existingSecret: "ghost-mysql-credentials"

            ## MySQL Primary configuration
            primary:
              # MySQL Primary Persistence parameters
              persistence:
                enabled: true
                existingClaim: "ghost-mysql"

              resources:
                requests:
                  cpu: 1
                  memory: 200Mi
                limits:
                  cpu: 3
                  memory: 1024Mi

              tolerations:
                - key: '{{ .ghost_toleration_key }}'
                  operator: '{{ .ghost_toleration_operator }}'
                  value: '{{ .ghost_toleration_value }}'
                  effect: '{{ .ghost_toleration_effect }}'

              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                      - matchExpressions:
                        - key: '{{ .ghost_affinity_key }}'
                          operator: In
                          values:
                            - '{{ .ghost_affinity_value }}'
