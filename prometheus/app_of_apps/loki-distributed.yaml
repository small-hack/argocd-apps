apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki-distributed-app
  namespace: argocd
spec:
  project: default
  destination:
    server: "https://kubernetes.default.svc"
    namespace: monitoring
  source:
    repoURL: 'https://grafana.github.io/helm-charts'
    chart: loki-distributed
    targetRevision: 0.80.5
    helm:
      version: v3
      skipCrds: true
      valuesObject:
        fullnameOverride: loki

        serviceAccount:
          create: true

        ########################################################################
        #  _          _    _
        # | |    ___ | | _(_)
        # | |   / _ \| |/ / |
        # | |__| (_) |   <| |
        # |_____\___/|_|\_\_|
        ########################################################################
        loki:
          # -- The number of old ReplicaSets to retain to allow rollback
          revisionHistoryLimit: 2

          auth_enabled: false

          existingSecretForConfig: "loki-config"


        ########################################################################
        #  ____                                 _
        # / ___|___  _ __ ___  _ __   __ _  ___| |_ ___  _ __
        #| |   / _ \| '_ ` _ \| '_ \ / _` |/ __| __/ _ \| '__|
        #| |__| (_) | | | | | | |_) | (_| | (__| || (_) | |
        # \____\___/|_| |_| |_| .__/ \__,_|\___|\__\___/|_|
        #                     |_|
        ########################################################################
        compactor:
          enabled: true

          serviceAccount:
            create: true

          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          kind: StatefulSet
          replicas: 1

          persistence:
            enabled: true
            size: 32Gi
            storageClass: local-path
            enableStatefulSetAutoDeletePVC: true
            whenDeleted: retain
            whenScaled: retain


        ########################################################################
        #   ____       _
        #  / ___| __ _| |_ _____      ____ _ _   _
        # | |  _ / _` | __/ _ \ \ /\ / / _` | | | |
        # | |_| | (_| | ||  __/\ V  V / (_| | |_| |
        #  \____|\__,_|\__\___| \_/\_/ \__,_|\__, |
        #                                    |___/
        ########################################################################
        gateway:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          replicas: 1

          autoscaling:
            enabled: false

        ########################################################################
        #  __  __                               _              _
        # |  \/  | ___ _ __ ___   ___ __ _  ___| |__   ___  __| |
        # | |\/| |/ _ \ '_ ` _ \ / __/ _` |/ __| '_ \ / _ \/ _` |
        # | |  | |  __/ | | | | | (_| (_| | (__| | | |  __/ (_| |
        # |_|  |_|\___|_| |_| |_|\___\__,_|\___|_| |_|\___|\__,_|
        ########################################################################
        memcachedchunks:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        memcachedfrontend:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        ########################################################################
        #  ____  _     _        _ _           _
        # |  _ \(_)___| |_ _ __(_) |__  _   _| |_ ___  _ __
        # | | | | / __| __| '__| | '_ \| | | | __/ _ \| '__|
        # | |_| | \__ \ |_| |  | | |_) | |_| | || (_) | |
        # |____/|_|___/\__|_|  |_|_.__/ \__,_|\__\___/|_|
        ########################################################################
        distributor:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          replicas: 1

          autoscaling:
            enabled: false

        ########################################################################
        #  ___                       _
        # |_ _|_ __   __ _  ___  ___| |_ ___ _ __
        #  | || '_ \ / _` |/ _ \/ __| __/ _ \ '__|
        #  | || | | | (_| |  __/\__ \ ||  __/ |
        # |___|_| |_|\__, |\___||___/\__\___|_|
        #            |___/
        ########################################################################
        ingester:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

          wal:
            enabled: false

          resources:
            requests:
              cpu: 250m
              memory: 1024Mi
            limits:
              cpu: 2
              memory: 4096Mi

          autoscaling:
            # -- Enable autoscaling for the ingester
            enabled: true
            # -- Minimum autoscaling replicas for the ingester
            minReplicas: 2
            # -- Maximum autoscaling replicas for the ingester
            maxReplicas: 3
            # -- Target CPU utilisation percentage for the ingester
            targetCPUUtilizationPercentage: 60
            # -- Target memory utilisation percentage for the ingester
            targetMemoryUtilizationPercentage: 70
            # -- Allows one to define custom metrics using the HPA/v2 schema (for example, Pods, Object or External metrics)
            customMetrics: []
            # - type: Pods
            #   pods:
            #     metric:
            #       name: loki_lines_total
            #     target:
            #       type: AverageValue
            #       averageValue: 10k
            behavior:
              # -- Enable autoscaling behaviours
              enabled: false
              # -- define scale down policies, must conform to HPAScalingRules
              scaleDown: {}
              # -- define scale up policies, must conform to HPAScalingRules
              scaleUp: {}

        indexGateway:
          enabled: true

          replicas: 1

        ########################################################################
        #   ___
        #  / _ \ _   _  ___ _ __ _   _
        # | | | | | | |/ _ \ '__| | | |
        # | |_| | |_| |  __/ |  | |_| |
        #  \__\_\\__,_|\___|_|   \__, |
        #                        |___/
        ########################################################################
        querier:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        queryFrontend:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        queryScheduler:
          extraArgs:
            - -memberlist.bind-addr=$(MY_POD_IP)

          extraEnv:
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP

        ########################################################################
        #  ____        _
        # |  _ \ _   _| | ___ _ __
        # | |_) | | | | |/ _ \ '__|
        # |  _ <| |_| | |  __/ |
        # |_| \_\\__,_|_|\___|_|
        #
        ########################################################################
        # Configuration for the ruler
        ruler:
          # -- Specifies whether the ruler should be enabled
          enabled: true

          # -- Kind of deployment [StatefulSet/Deployment]
          kind: Deployment

          # -- Number of replicas for the ruler
          replicas: 1

          # -- Additional CLI args for the ruler
          extraArgs: []

          # -- Environment variables to add to the ruler pods
          extraEnv: []

          # -- Environment variables from secrets or configmaps to add to the ruler pods
          extraEnvFrom: []

          # -- Volume mounts to add to the ruler pods
          extraVolumeMounts: []
            # these are the rules for entire clusters
            # located in https://github.sie.sony.com/Guerrilla/dope-monitoring-control-plane/tree/main/charts/loki-rules
            # - name: fake
            #  mountPath: /etc/loki/rules/fake

          # -- Volumes to add to the ruler pods
          extraVolumes: []
            # these are the rules for entire clusters
            # located in https://github.sie.sony.com/Guerrilla/dope-monitoring-control-plane/tree/main/charts/loki-rules
            # - name: fake
            #  configMap:
            #    name: loki-cluster-rules

          # -- Resource requests and limits for the ruler
          resources: {}

          # -- Grace period to allow the ruler to shutdown before it is killed
          terminationGracePeriodSeconds: 300

          # -- Pod Disruption Budget maxUnavailable
          maxUnavailable: null

          persistence:
            # -- Enable creating PVCs which is required when using recording rules
            enabled: true

            # -- Size of persistent disk
            size: 10Gi

            # -- Storage class to be used.
            storageClass: local-path

          # -- Set the optional grpc service protocol. Ex: "grpc", "http2" or "https"
          appProtocol:
            grpc: ""
  syncPolicy:
    syncOptions:
      - ApplyOutOfSyncOnly=true
    automated:
      selfHeal: true
