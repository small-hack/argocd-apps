---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"

spec:
  project: default

  # where to put the argocd app
  destination:
    server: "https://kubernetes.default.svc"
    namespace: prometheus

  # how to sync the argocd app
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
      - ApplyOutOfSyncOnly=true
      - Retry=true

    automated:
      selfHeal: true
      prune: true

  source:
    # Official Grafana Loki helm chart
    # https://github.com/grafana/loki/tree/main/production/helm/loki
    repoURL: oci://ghcr.io/grafana/helm-charts
    chart: loki
    # this'll be set automatically by kargo down the line
    targetRevision: 6.36.0
    helm:
      releaseName: loki
      skipCrds: true
      # values for the loki helm chart
      # ref: https://github.com/grafana/loki/blob/main/production/helm/loki/values.yaml
      valuesObject:
        loki:
          configStorageType: Secret

          storage_config:
            tsdb_shipper:
              active_index_directory: /data/tsdb-index
              cache_location: /data/tsdb-cache
              index_gateway_client:
                # only applicable if using microservices where index-gateways are independently deployed.
                # This example is using kubernetes-style naming.
                server_address: dns:///index-gateway.prometheus.svc.cluster.local:9095
              shared_store: gcs
